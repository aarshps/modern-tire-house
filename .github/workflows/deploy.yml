name: Deploy Website via FTP

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version/tag to deploy (e.g., v1.2.3). If empty, will deploy the latest release.'
        required: false
        type: string

jobs:
  deploy:
    name: Sync Files to cPanel Server
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version || 'main' }}
          
      - name: Get latest release if version not specified
        if: ${{ !github.event.inputs.version }}
        run: |
          echo "No version specified. Fetching latest release..."
          LATEST_RELEASE=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/latest" | \
            jq -r '.tag_name')
          echo "Latest release is: $LATEST_RELEASE"
          echo "LATEST_RELEASE=$LATEST_RELEASE" >> $GITHUB_ENV
          
      - name: Checkout specific release
        if: ${{ !github.event.inputs.version }}
        uses: actions/checkout@v4
        with:
          ref: ${{ env.LATEST_RELEASE }}
          
      - name: Sync files via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: public_html/